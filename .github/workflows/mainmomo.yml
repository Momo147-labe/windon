name: Cr√©er un programme d'installation Windows

on:
  push:
    branches: [principale]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout du d√©p√¥t
      - name: D√©p√¥t de v√©rification
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configuration Flutter
      - name: Configuration de Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # 3Ô∏è‚É£ Activer Windows Desktop
      - name: Activer le bureau Windows
        run: flutter config --enable-windows-desktop

      # 4Ô∏è‚É£ Installer les d√©pendances Flutter
      - name: Installer les d√©pendances
        run: flutter pub get

      # 5Ô∏è‚É£ Supprimer les builds pr√©c√©dents
      - name: Nettoyer l'ancienne build
        run: flutter clean

      # 6Ô∏è‚É£ Build Windows Release
      - name: G√©n√©rer EXE Windows
        run: flutter build windows --release

      # 7Ô∏è‚É£ V√©rifier la sortie
      - name: V√©rifier dossier Release
        shell: pwsh
        run: |
          if (!(Test-Path "build/windows/x64/runner/Release")) {
            Write-Error "‚ùå Dossier Release introuvable"
            exit 1
          }
          Get-ChildItem build/windows/x64/runner/Release

      # 8Ô∏è‚É£ D√©tecter le .exe
      - name: Obtenir le nom de l'EXE
        shell: pwsh
        run: |
          $exe = Get-ChildItem build/windows/x64/runner/Release/*.exe | Select-Object -First 1
          if (-not $exe) {
            Write-Error "‚ùå Aucun EXE trouv√©"
            exit 1
          }
          echo "EXE_NAME=$($exe.Name)" >> $env:GITHUB_ENV
          Write-Host "‚úî EXE trouv√© : $($exe.Name)"

      # 9Ô∏è‚É£ Installer Inno Setup
      - name: Installer Inno Setup
        run: choco install innosetup -y

      # üîü V√©rifier que installer.iss existe
      - name: V√©rifier installer.iss
        shell: pwsh
        run: |
          if (!(Test-Path "installer.iss")) {
            Write-Error "‚ùå installer.iss introuvable !"
            exit 1
          }
          Write-Host "‚úî installer.iss trouv√©"

      # 1Ô∏è‚É£1Ô∏è‚É£ G√©n√©rer Setup.exe avec ISCC
      - name: G√©n√©rer Setup.exe avec Inno Setup
        shell: pwsh
        run: |
          mkdir Output -Force
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer.iss"

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload Setup.exe comme artefact
      - name: Upload Setup.exe
        uses: actions/upload-artifact@v3
        with:
          name: Windows-Setup
          path: Output/*.exe
